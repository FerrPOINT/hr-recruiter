<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .recorder-section {
            border: 2px solid #e0e0e0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        .record-btn {
            background-color: #dc3545;
        }
        .record-btn:hover { background-color: #c82333; }
        .record-btn.recording {
            background-color: #28a745;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.recording {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.ready {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .audio-player {
            margin: 20px 0;
        }
        audio {
            width: 100%;
            max-width: 400px;
        }
        .result {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            white-space: pre-wrap;
            border-left: 4px solid #007bff;
        }
        .result.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .result.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .waveform {
            height: 60px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        .waveform-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            background-color: #007bff;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</h1>
        
        <div class="recorder-section">
            <h2>–ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ</h2>
            
            <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏</div>
            
            <div class="timer" id="timer">00:00</div>
            
            <div class="waveform" id="waveform">
                <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="controls">
                <button id="startRecord" class="record-btn">üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button id="stopRecord" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button id="playRecord" disabled>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
                <button id="clearRecord" disabled>üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            
            <div class="audio-player" id="audioPlayer" style="display: none;">
                <audio id="audioElement" controls></audio>
            </div>
        </div>

        <div class="recorder-section">
            <h2>–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</h2>
            
            <div class="controls">
                <button id="testSimpleUpload" disabled>üì§ –¢–µ—Å—Ç –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–¥–∞—á–∏</button>
                <button id="testTranscribe" disabled>üéµ –¢–µ—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏</button>
                <button id="testAIProcessing" disabled>ü§ñ –¢–µ—Å—Ç AI –æ–±—Ä–∞–±–æ—Ç–∫–∏</button>
            </div>
            
            <div class="result" id="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let audioUrl;
        let recordingStartTime;
        let timerInterval;
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let animationId;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const startRecordBtn = document.getElementById('startRecord');
        const stopRecordBtn = document.getElementById('stopRecord');
        const playRecordBtn = document.getElementById('playRecord');
        const clearRecordBtn = document.getElementById('clearRecord');
        const statusDiv = document.getElementById('status');
        const timerDiv = document.getElementById('timer');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioElement = document.getElementById('audioElement');
        const waveform = document.getElementById('waveform');
        const resultDiv = document.getElementById('result');

        // –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        const testSimpleUploadBtn = document.getElementById('testSimpleUpload');
        const testTranscribeBtn = document.getElementById('testTranscribe');
        const testAIProcessingBtn = document.getElementById('testAIProcessing');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                updateStatus('ready', '–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏');
                startRecordBtn.disabled = false;
                
            } catch (error) {
                updateStatus('error', `–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`);
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(type, message) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
        function updateTimer() {
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDiv.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞
        function drawWaveform() {
            if (!analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –±–∞—Ä—ã
            waveform.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –±–∞—Ä—ã
            const barWidth = waveform.offsetWidth / dataArray.length;
            for (let i = 0; i < dataArray.length; i++) {
                const barHeight = (dataArray[i] / 255) * waveform.offsetHeight;
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.left = `${i * barWidth}px`;
                bar.style.height = `${barHeight}px`;
                waveform.appendChild(bar);
            }
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                animationId = requestAnimationFrame(drawWaveform);
            }
        }

        // –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
        startRecordBtn.addEventListener('click', async () => {
            try {
                audioChunks = [];
                recordingStartTime = Date.now();
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioUrl = URL.createObjectURL(audioBlob);
                    audioElement.src = audioUrl;
                    
                    updateStatus('ready', '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                    startRecordBtn.disabled = false;
                    stopRecordBtn.disabled = true;
                    playRecordBtn.disabled = false;
                    clearRecordBtn.disabled = false;
                    testSimpleUploadBtn.disabled = false;
                    testTranscribeBtn.disabled = false;
                    testAIProcessingBtn.disabled = false;
                    audioPlayer.style.display = 'block';
                    
                    clearInterval(timerInterval);
                    cancelAnimationFrame(animationId);
                };
                
                mediaRecorder.start();
                startRecordBtn.disabled = true;
                stopRecordBtn.disabled = false;
                playRecordBtn.disabled = true;
                clearRecordBtn.disabled = true;
                testSimpleUploadBtn.disabled = true;
                testTranscribeBtn.disabled = true;
                testAIProcessingBtn.disabled = true;
                audioPlayer.style.display = 'none';
                
                updateStatus('recording', '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...');
                startRecordBtn.classList.add('recording');
                
                timerInterval = setInterval(updateTimer, 1000);
                drawWaveform();
                
            } catch (error) {
                updateStatus('error', `–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error.message}`);
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', error);
            }
        });

        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
        stopRecordBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                startRecordBtn.classList.remove('recording');
            }
        });

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–∞–ø–∏—Å—å
        playRecordBtn.addEventListener('click', () => {
            audioElement.play();
        });

        // –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å
        clearRecordBtn.addEventListener('click', () => {
            audioChunks = [];
            audioBlob = null;
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl);
                audioUrl = null;
            }
            audioElement.src = '';
            audioPlayer.style.display = 'none';
            playRecordBtn.disabled = true;
            clearRecordBtn.disabled = true;
            testSimpleUploadBtn.disabled = true;
            testTranscribeBtn.disabled = true;
            testAIProcessingBtn.disabled = true;
            resultDiv.style.display = 'none';
            timerDiv.textContent = '00:00';
            updateStatus('ready', '–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏');
        });

        // –¢–µ—Å—Ç –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
        testSimpleUploadBtn.addEventListener('click', async () => {
            if (!audioBlob) {
                showResult('error', '–ù–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                return;
            }
            
            try {
                showResult('', '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...');
                
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.webm');
                
                const response = await fetch(`${API_BASE}/ai/test-audio-upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                showResult(
                    result.success ? 'success' : 'error',
                    `–°—Ç–∞—Ç—É—Å: ${response.status}\n–û—Ç–≤–µ—Ç: ${JSON.stringify(result, null, 2)}`
                );
                
            } catch (error) {
                showResult('error', `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        });

        // –¢–µ—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏
        testTranscribeBtn.addEventListener('click', async () => {
            if (!audioBlob) {
                showResult('error', '–ù–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                return;
            }
            
            try {
                showResult('', '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é...');
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                
                const response = await fetch(`${API_BASE}/ai/transcribe`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                showResult(
                    response.ok ? 'success' : 'error',
                    `–°—Ç–∞—Ç—É—Å: ${response.status}\n–û—Ç–≤–µ—Ç: ${JSON.stringify(result, null, 2)}`
                );
                
            } catch (error) {
                showResult('error', `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        });

        // –¢–µ—Å—Ç AI –æ–±—Ä–∞–±–æ—Ç–∫–∏
        testAIProcessingBtn.addEventListener('click', async () => {
            if (!audioBlob) {
                showResult('error', '–ù–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                return;
            }
            
            try {
                showResult('', '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ AI –æ–±—Ä–∞–±–æ—Ç–∫—É...');
                
                const formData = new FormData();
                formData.append('audioFile', audioBlob, 'recording.webm');
                formData.append('interviewId', '1');
                formData.append('questionId', '1');
                
                const response = await fetch(`${API_BASE}/ai/transcribe-answer`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                showResult(
                    response.ok ? 'success' : 'error',
                    `–°—Ç–∞—Ç—É—Å: ${response.status}\n–û—Ç–≤–µ—Ç: ${JSON.stringify(result, null, 2)}`
                );
                
            } catch (error) {
                showResult('error', `–û—à–∏–±–∫–∞: ${error.message}`);
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(type, message) {
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        init();
    </script>
</body>
</html> 